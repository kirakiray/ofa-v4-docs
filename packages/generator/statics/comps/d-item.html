<template component>
  <style host>
    d-item[hide-childs] d-nav d-item {
      margin-top: 0;
      margin-bottom: 0;
    }

    d-item[hide-childs] d-nav d-item a,
    d-item[hide-childs] d-nav d-item span {
      padding-top: 0;
      padding-bottom: 0;
      line-height: 0px;
      opacity: 0;
    }
  </style>
  <style>
    :host {
      display: block;
      margin: 5px 0;
      font-weight: 500;
      user-select: none;
      transition: all ease 0.3s;
    }

    ::slotted(a),
    ::slotted(span) {
      display: block;
      padding: 5px 0 5px 8px;
      transition: all ease 0.3s;
    }

    .container {
      position: relative;
      border-radius: 5px;
      font-size: 16px;
      line-height: 20px;
      cursor: pointer;
      overflow: hidden;
      transition: all ease 0.2s;
    }

    .container.hide {
      padding-top: 0;
      padding-bottom: 0;
      line-height: 0px;
      color: transparent;
    }

    :host([active]) .container {
      color: var(--active-color);
      background-color: var(--aside-hover-bg);
      cursor: default;
    }

    :host([active="2"]) .container {
      background-color: transparent;
      cursor: pointer;
    }

    .container:hover,
    :host([active="2"]) .container:hover {
      background-color: var(--aside-hover-bg);
    }

    .nav {
      margin-left: 16px;
    }

    .arrow {
      position: absolute;
      right: 0;
      top: 0;
      width: 30px;
      height: 30px;
      background-image: url(./sources/angle-right.svg);
      background-position: center;
      background-size: 40%;
      background-repeat: no-repeat;
      transition: all ease 0.2s;
    }

    .arrow.rotate {
      transform: rotate(90deg);
    }
  </style>
  <div class="container" on:click="showChilds = !showChilds" class:hide="hide">
    <slot></slot>
    <x-if :value="showArrow">
      <div class="arrow" class:rotate="showChilds"></div>
    </x-if>
  </div>
  <div class="nav">
    <slot name="nav"></slot>
  </div>
  <script>
    export default async function () {
      return {
        attrs: {
          active: null,
          hideChilds: null,
        },

        data: {
          showArrow: false,
          showChilds: true,
          hide: false,
        },
        watch: {
          showChilds(bool) {
            this.hideChilds = bool ? null : "";

            // const nav = this.$("d-nav");
            // if (nav) {
            //   if (bool) {
            //     nav.forEach((e) => {
            //       e.hide = false;
            //     });
            //   } else {
            //     nav.forEach((e) => {
            //       e.hide = true;
            //     });
            //   }
            // }
          },
        },
        proto: {
          setActive() {
            if (!this.$('[slot="nav"]')) {
              // 判断是否有父层，将父层的 item 都带上 active=2
              const parentItems = this.parents.filter(
                (e) => e.tag === "d-item"
              );
              parentItems.forEach((e) => (e.active = "2"));
              this.active = "";
            }
          },
        },
        ready() {
          this.shadow.on("slotchange", () => {
            if (this.$("[slot='nav']")) {
              this.showArrow = true;
            } else {
              this.showArrow = false;
            }
          });
        },
      };
    }
  </script>
</template>
