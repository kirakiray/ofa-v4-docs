<template page>
  <l-m src="../comps/doc-container.html"></l-m>
  <style>
    :host {
      display: block;
      width: 100%;
      height: 100%;
    }

    a {
      display: block;
      height: 100%;
      color: inherit;
      text-decoration: none;
    }
  </style>
  <article-container>
    <doc-aside slot="aside">
      <d-nav>
        <!-- <d-item>Release notes</d-item>
        <d-item>Installation</d-item>
        <d-item>Writing tests tests tests tests tests tests</d-item>
        <d-item>
          Running tests
          <d-nav slot="nav">
            <d-item>Running tests 1</d-item>
            <d-item>Running tests 2</d-item>
            <d-item>Running tests 3</d-item>
          </d-nav>
        </d-item> -->
        <x-fill name="item" :value="articles"></x-fill>
      </d-nav>
    </doc-aside>
    <template name="item">
      <d-item attr:active="$host.leftGetActive($data)">
        <x-if :value="$data.href">
          <a attr:href="$data.href" olink>{{$data.name}}</a>
        </x-if>
        <x-else>
          <span> {{$data.name}}</span>
          <d-nav slot="nav">
            <x-fill :value="$data.childs" name="item"></x-fill>
          </d-nav>
        </x-else>
      </d-item>
    </template>
    <div style="padding: 16px 24px 0; position: relative">
      <slot></slot>
    </div>
    <article-nav slot="right-aside">
      <ul>
        <x-fill :value="rightNavs">
          <li
            class:invis="$host.visNavs.includes($data.id)"
            class:active="$data.active"
            attr:type="$data.type"
          >
            <a attr:href="$data.href">{{$data.name}}</a>
          </li>
        </x-fill>
      </ul>
      <!-- <ul>
        <li>
          <a href="">Inline HTML0</a>
        </li>
        <li class="invis">
          <a href="">Inline HTML1</a>
        </li>
        <li class="active invis">
          <a href="">Inline HTML2</a>
        </li>
        <li class="invis">
          <a href="">Inline HTML3</a>
        </li>
        <li>
          <a href="">Inline HTML4</a>
        </li>
      </ul> -->
    </article-nav>
  </article-container>
  <script>
    export const parent = "./header-layout.html";

    export const data = {
      articles: [],
      rightNavs: [],
      // 正文内可视的导航标题
      visNavs: [],
      // 所有文章数据
      _articlesBase: [],
      // 当前所处的 article name
      currentArticleIndex: "",
    };

    export function ready() {
      this.attr("id", "article-layout");
    }

    export function attached() {
      this.refreshLeftNav();
      this.refreshRightNav();

      let f;
      window.addEventListener(
        "hashchange",
        (f = (e) => {
          const hash = decodeURIComponent(location.hash);

          if (hash) {
            const target = this[0].shadow.$(hash);
            if (target) {
              target.ele.scrollIntoView({
                behavior: "smooth",
              });
            }
          } else {
            $("#header-layout").shadow.$("doc-container").scrollTop = 0;
          }
        })
      );
      this.__hash_change = f;
    }

    export function detached() {
      window.removeEventListener("hashchange", this.__hash_change);
    }

    export const proto = {
      leftGetActive(data) {
        const now = `${location.origin}${location.pathname}`;
        if (data.href === now) {
          return "";
        }

        return null;
      },
      init(data) {
        this._articlesBase = data;

        this.refreshLeftNav();
        this.refreshRightNav();
      },
      refreshLeftNav() {
        if (!this._articlesBase.length) {
          return;
        }

        const target = this._articlesBase.find((e) => {
          const reg = new RegExp(e.href.replace(/(.+)\/.+/, "$1"));

          if (reg.test(location.href)) {
            return true;
          }
        });

        if (target !== this._nowBase) {
          this._nowBase = target;

          // 修正左侧导航
          console.log("this._articlesBase => ", target.navs);
          this.articles = target.navs;
        }
      },
      refreshRightNav() {
        const article = this.app.current.shadow.$("article");

        let count = 0;
        let beforeTitle = "";

        article.forEach((childEl) => {
          if (["h1", "h2", "h3", "h4", "j5"].includes(childEl.tag)) {
            beforeTitle = childEl.text.trim() + `-title${count}`;
            count++;
          }

          childEl.data.sutitle = replaceSpecialCharacters(beforeTitle);
        });

        const titles = article.all("h1,h2,h3,h4,h5");

        this.rightNavs = titles.map((e, index) => {
          const id = `${replaceSpecialCharacters(e.text.trim())}-title${index}`;

          e.html = `<a class="anchor" href="#${id}"><span class="octicon-link"></span> </a>${e.text}`;

          e.attr("id", id);

          return {
            id,
            type: e.tag.toLowerCase(),
            name: e.text.trim(),
            href: "#" + id,
          };
        });

        if (this._oldIO) {
          this._oldIO.disconnect();
        }

        const visibles = [];

        let timer;

        const refreshRightActive = () => {
          const shows = new Set();
          visibles.forEach((e) => {
            shows.add(e.dataset.sutitle);
          });

          this.visNavs = Array.from(shows);

          let hasActive;
          this.rightNavs.forEach((e) => {
            e.active = null;
            if (hasActive) {
              return;
            }

            if (shows.has(e.id)) {
              e.active = 1;
              hasActive = 1;
            }
          });

          this.shadow.$("article-nav").focusScroll &&
            this.shadow.$("article-nav").focusScroll();
        };

        const observer = (this._oldIO = new IntersectionObserver(
          (entries, observer) => {
            for (const entry of entries) {
              if (entry.isIntersecting) {
                visibles.push(entry.target);
              } else {
                const id = visibles.indexOf(entry.target);
                if (id > -1) {
                  visibles.splice(id, 1);
                }
              }
            }

            if (timer) {
              return;
            }

            timer = setTimeout(() => {
              refreshRightActive();
              timer = null;
            }, 50);
          }
        ));

        article.forEach((e) => {
          observer.observe(e.ele, {});
        });
      },
    };

    export function routerChange(e) {
      this.refreshLeftNav();
      this.refreshRightNav();
    }

    function replaceSpecialCharacters(str) {
      const specialCharacters = /[\s!@#$%^&*()\-\+=\[\]{}|\\/,.;'"<>?]/g;
      return str.replace(specialCharacters, "-");
    }
  </script>
</template>
