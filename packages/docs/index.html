<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>test obook</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }
    </style>
    <script
      src="https://cdn.jsdelivr.net/gh/kirakiray/ofa.js@4.3.14/dist/ofa.min.js"
      debug
    ></script>
  </head>
  <body>
    <!-- <l-m src="http://127.0.0.1:5512/src/book-tool.html"></l-m> -->
    <l-m
      src="https://cdn.jsdelivr.net/npm/o-book@2.0.8/src/book-tool.html"
    ></l-m>
    <book-tool sw="./sw.js">
      <source src="./en/config.json" lang="en" />
      <source src="./cn/config.json" lang="cn" />
      <source src="./t-cn/config.json" lang="t-cn" />
      <source src="./es/config.json" lang="es" />
      <template inject-head>
        <script
          async
          src="https://www.googletagmanager.com/gtag/js?id=G-7L1TCCJZT6"
        ></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag("js", new Date());

          gtag("config", "G-7L1TCCJZT6");
        </script>
        <script>
          (async () => {
            async function getHash(str, algorithm = "SHA-256") {
              const encoder = new TextEncoder();
              const data = encoder.encode(str);
              const hashBuffer = await crypto.subtle.digest(algorithm, data);
              const hashArray = Array.from(new Uint8Array(hashBuffer));
              const hashHex = hashArray
                .map((byte) => byte.toString(16).padStart(2, "0"))
                .join("");
              return hashHex;
            }

            // 注册 sw 服务
            const swText = await fetch("/sw.js")
              .then((e) => {
                if (e.status == 200) {
                  return e.text();
                }

                return false;
              })
              .catch(() => false);

            if (swText) {
              const hsId = await getHash(swText);

              navigator.serviceWorker
                .register("/sw.js", {
                  scope: "/",
                })
                .then((reg) => {
                  if (localStorage._swid !== hsId) {
                    reg.update();
                    localStorage._swid = hsId;
                  }

                  setTimeout(() => {
                    reg.update();
                  }, 60 * 60 * 1000);
                })
                .catch((err) => {
                  console.error(err);
                });
            }
          })();
        </script>
      </template>
    </book-tool>
  </body>
</html>
